# MySQL 技能图谱

## 数据库基础

### 概念

简而言之可视为电子化的文件柜——存储电子文件的处所，用户可以对文件中的数据运行新增、截取、更新、删除等操作。所谓「数据库」系以一定方式储存在一起、能予多个用户共享、具有尽可能小的冗余度、与应用程序彼此独立的数据集合。一个数据库由多个表空间（Tablespace）构成。

### 模型

- 分类

	- 概念数据模型

		- 面向用户的，按照用户的观点进行建模，典型代表：E-R 图

	- 结构数据模型

		- 面向计算机系统的，用于 DBMS 的实现，典型代表有：层次模型，网状模型、关系模型、面向对象模型

- 三要素

	- 数据结构
	- 数据操作
	- 数据约束

- 概念数据模型

	- E-R 图（实体-联系图，Entity Relationship Diagram）

		- 实体、联系、属性
		- 一对一（1:1）、一对多（1:N）、多对多（M:N）
		- 既表示实体，也表示实体之间的联系，是现实世界的抽象，与计算机系统没有关系， 是可以被用户理解的数据描述方式。用户与系统设计者进行交流的工具
		- 实体用矩形框表示，联系用菱形表示，属性用椭圆表示

	- 示例（拉伸放大与缩小）

- 结构数据模型

	- 层次模型

		- 树形结构表示数据与数据之间的关系
		- 不能直接表示多对多的联系

	- 网状模型

		- 用网络结构表示数据与数据之间的联系的模型
		- 子节点和父节点联系不唯一，需要为联系命名
		- 更直观的描述世界，良好的性能，缺点是结构复杂

	- 关系模型

		- 采用表格结构表达实体集以及实体之间的联系，最大的特色就是描述的一致性。
		- 关系是一张表，关系数据模型由若干个表组成。
		- 可以存在1对1，1对多，多对多的关系

	- 面向对象模型

		- 指属性和操作属性的方法封装在称为对象类的结构中的模型。
		- 成分、概念

			- 对象
			- 类（对象类）
			- 类层次
			- 对象标识
			- 对象包含

### 常见数据库

- Oracle、DB2、SQL Server、PostgreSQL、MySQL、Sybase、Access、Informix、FoxPro、Redis、MongoDB

### 事务的基本概念

- 定义

	- 作为单个逻辑工作单元执行的一系列操作，要么完全地执行，要么完全地不执行。 事务处理可以确保除非事务性单元内的所有操作都成功完成，否则不会永久更新面向数据的资源。通过将一组相关操作组合为一个要么全部成功要么全部失败的单元，可以简化错误恢复并使应用程序更加可靠。一个逻辑工作单元要成为事务，必须满足所谓的ACID（原子性、一致性、隔离性和持久性）属性。事务是数据库运行中的一个逻辑工作单位，由DBMS中的事务管理子系统负责事务的处理。

- ACID 原则

	- 原子性(Atomicity)

		- 事务中的所有元素作为一个整体提交或回滚，事务的个体元素是不可分的，事务是一个完整操作。

	- 一致性(Consistemcy)

		- 事务完成时，数据必须是一致的，也就是说，和事务开始之前，数据存储中的数据处于一致状态。保证数据的无损。

	- 隔离性(Isolation)

		- 对数据进行修改的多个事务是彼此隔离的。这表明事务必须是独立的，不应该以任何方式依赖于或影响其他事务。

	- 持久性(Durability)

		- 事务完成之后，它对于系统的影响是永久的，该修改即使出现系统故障也将一直保留，真实的修改了数据库。

## 数据库设计基础

### 设计规范

- 三范式

	- 第一范式（1NF）

		- 字段具有「原子性」 , 不可再分 。所有关系型数据库系统都满足第一范式。数据库表中的字段都是单一属性的，不可再分。例如，姓名字段，其中的姓和名必须作为一个整体，无法区分哪部分是姓，哪部分是名，如果要区分出姓和名，必须设计成两个独立的字段。

	- 第二范式（2NF）

		- 在第一范式的基础上建立起来的，满足第二范式必须先满足第一范式。要求数据库表中的每个实例或行必须可以被惟一地区分 。通常需要为表加上一个列，以存储各个实例的惟一标识。这个惟一属性列被称为主关键字或主键 。

	- 第三范式（3NF）

		-  必须先满足第二范式 。要求一个数据库表中不包含已在其它表中已包含的非主关键字信息
		- 特征

			- 每一列只有一个值
			- 每一行都能区分
			- 每一个表都不包含其他表已经包含的非主关键字信息

### 设计方法

- 设计目标

	- 满足应用功能
	- 良好的数据库性能

- 设计过程

	- 需求分析
	- 结构设计

		- 概念结构设计
		- 逻辑结构设计
		- 物理结构设计

	- 行为设计

		- 功能设计
		- 事务设计
		- 程序设计

	- 数据库实施

		- 加载数据库数据
		- 调试运行应用程序

	- 数据库运行和维护阶段

### 设计评审

## MySQL 基础知识

### 安装与配置

- Windows

	- 傻瓜式安装

- Linux

	- 安装 5.6

		- http://www.glorze.com/322.html

	- 安装 5.7

		- http://www.glorze.com/1412.html

- Mac

	- 傻瓜式安装

### 启动与关闭

- 主要体现在 Linux 中的一些命令，不同版本也有不同的实现，主要有 syetemctl start/stop mysql、service start/stop mysql 等

### 常用工具

- Navicat

	- http://www.glorze.com/320.html

- SqlYog

### 基本结构

- 客户端

	- 拖拽放大图片

- 连接器

	- 管理连接，权限验证

- 查询缓存

	- 命中则直接返回结果

- 分析器

	- 词法分析，语法分析

- 优化器

	- 执行计划生成，索引选择

- 执行器

	- 操作引擎，返回结果

- 存储引擎

	- 存储数据，提供读写接口

### 常用存储引擎

- MyISAM存储引擎（Full-text 索引，解决 like 查询低下）
- Innodb存储引擎（事务、外键）
- NDBCluster 存储引擎（分布式集群）
- Merge 存储引擎（为 MyISAM 提供统一接口）
- Memory 存储引擎（数据存储在内存中，不支持BLOB 和 TEXT）
- BDB 存储引擎（和 InnoDB 基本一样）
- FEDERATED 存储引擎（远程服务）
- BLACKHOLE 存储引擎（有去无回）
- CSV存储引擎（报表文件）

## MySQL开发基础

### SQL 语句

- 数据操纵语言

	- DDL（Data Definition Language），数据定义语言
	- DCL（Data Control Language），数据控制语言
	- DML（data manipulation language），数据操纵语言。

		- INSERT 插入、UPDATE 更新、DELETE 删除

	- DQL（Data Query Language），数据查询语言-select 关键字

- 同构/异构

	- 同构

		- 两个 SQL 语句可编译的部分是相同的，只是参数不一样而已
		- 在 JDBC 中，PreparedStatement 执行同构 SQL 语句的效率是比较高的，因为 PreparedStatement 对象一旦绑定了 SQL 语句，就只能执行这一条 SQL 语句

	- 异构

		- 两个 SQL 语句整个的格式都是不同的。 
		- Statement 则执行异构的 SQL 语句效率更高

### CRUD

### 视图

### 存储过程

### 游标

### 触发器

### 事务

## MySQL 高级开发

### 事务

- 原子性（Atomic）

  事务中包含的操作被看作一个整体的业务单元，这个业务单元中的操作要么全部成功，要么全部失败，不会出现部分失败、部分成功的场景。

- 一致性（Consistency）

  事务在完成时，必须使所有的数据都保持一致状态，在数据库中所有的修改都基于事务，保证了数据的完整性。

- 隔离性（Isolation）

	- 隔离级别（当前读）

		- 未提交读（Read Uncommited）：脏读

			- 可以读取未提交记录。此隔离级别，不会使用，忽略。

		- 读写提交（Read Committed，RC）：幻读

			- 一个事务只能读取另外一个事务己经提交的数据，
不能读取未提交的数据。
			- 幻读的意思其实就是读写提交会产生不可重复读的问题

		- 可重复读（Repeatable Read，RR）

			- 字面的意思就是必须等上一个事务提交才能进行当前事务的读取操作，保证数据正确性。
			- RR 隔离级别保证对读取到的记录加锁 (记录锁)，同时保证对读取的范围加锁，新的满足查询条件的记录不能够插入 (间隙锁)，不存在幻读现象。


			- 在这里里面也有一个「幻读」的概念，不过可重复读产生幻读的现象不属于数据库存储的值，多半是统计值或者计算值。

		- 串行化（Serializable）

			- 从 MVCC 并发控制退化为基于锁的并发控制。不区别快照读与当前读，所有的读操作均为当前读，读加读锁 (S锁，共享锁)，写加写锁 (X锁，排它锁)。
			- Serializable 隔离级别下，读写冲突，因此并发度急剧下降，在 MySQL/InnoDB 下不建议使用。

- 持久性（Durability）

  事务结束后，所有的数据会固化到一个地方，如保存到磁盘当中，即使断电重启后也可以提供给应用程序访问。

### 锁

- 锁

	- 共享锁
	- 排它锁
	- 乐观锁
	- 悲观锁
	- GAP 锁
	- 2PL（二阶段锁）：

		- 加锁阶段
		- 解锁阶段
		- 保证加锁阶段与解锁阶段不相交。

	- 死锁

	  死锁的发生与否，并不在于事务中有多少条 SQL 语句，死锁的关键在于：两个或以上的 Session 加锁的顺序不一致。

### 索引

- 索引（B+树）

  索引是一种数据结构，用于加快mysql获取数据的速度；
  
  常见索引模型：哈希表、有序数组、搜索树。
  
  索引类型：主键索引（存储整行数据）、非主键索引（主键的值，需要回表两次查询）

	- 数据结构角度

		- B+ 树索引（查询性能高、IO 次数少、范围查询简便）

			- 每一个父节点的元素都出现在子节点中，是子节点的最大或最小元素。
			- 非叶子节点不保存数据，只保存关键字用作索引，所有数据都保存在叶子节点中。
			- 内部节点不保存数据，所以能在内存中存放更多索引，增加缓存命中率。

		- 哈希索引（单行查询快）

		  哈希索引基于哈希表实现，只有精确匹配索引的所有列的查询才有效。对于每一行数据，存储引擎都会对所有的索引列计算一个哈希码，哈希码是一个较小的值，并且不同键值的行计算出来的哈希码也不一样。哈希索引将所有的哈希码存储在索引中，同时在哈希表中保存指向每个数据行的指针。
		  
		  作者：counterxing
		  链接：https://www.zhihu.com/question/67094336/answer/250034118
		  来源：知乎
		  著作权归作者所有。商业转载请联系作者获得授权，非商业转载请注明出处。

			- 无法用于排序
			- 仅支持 < = > 以及 IN 操作
			- 哈希冲突比较多的话，维护代价高
			- 不能避免全表扫描
			- 不支持部分索引列匹配查找

		- FULLTEXT 全文索引（MyISAM 和 InnoDB）

			- 更建议使用 Lucene、Solar 等

		- R-Tree索引

			- 解决空间数据检索的问题。

	- 物理存储角度

		- 聚簇索引（Cluster Index）

			- InnoDB 存储引擎的数据组织方式就是聚簇索引表，完整的记录，存储在主键索引中，通过主键索引，就可以获取记录所有的列。

		- 非聚簇索引

			- MyISAM 就是非聚簇索引
			- 叶子节点仍然是索引节点，只不过有指向对应数据块的指针。

	- 逻辑角度

		- 主键索引，特殊的唯一索引，不允许为空，整行索引
		- 普通索引、单列索引
		- 多列索引、复合索引（遵循最左前缀原则）
		- 唯一索引或者非唯一索引
		- 空间索引（只存在 MYISAM 存储引擎中）

	- 设计索引的原则

		- 搜索的索引列，出现在 where 子句中的列
		- 使用唯一索引
		- 使用短索引，对字符串列进行索引，去字符串的前 N 个字符
		- 利用最左前缀，可以是联合索引的最左N个字段，也可以是字符串索引的最左M个字符。
		- 不要过度索引，占磁盘空间，降低写操作性能。
		- InnoDB 尽量自己指定主键

	- 面试常问的「主键索引、唯一索引和普通索引的区别」

		- 主键索引

			- 主键索引只要搜索ID这个B+Tree即可拿到数据。
			- 不允许空值

		- 唯一索引

			- 必须唯一，允许空值

		- 普通索引

			- 普通索引先搜索索引拿到主键值，再到主键索引树搜索一次(回表)

			  回到主键索引树搜索的过程，称为回表

### SQL 模式

- SELECT @@GLOBAL.sql_mode;
- ANSI
- DB2
- MSSQL
- POSTGRESQL
- ORACLE
- MAXDB
- TRADITIONAL

### 分区表

- 分区类型

	- 水平分区

		- 将同一表中不同行的记录分配到不同的物理文件中；

	- 垂直分区

		- 将同一表中不同列的记录分配到不同的物理文件中；

- 分区表类型

	- 范围分区（RANGE）
	- 列表分区（LIST）
	- 哈希分区（HASH）
	- KEY 分区

- 分区管理

	- 增删改查

## MySQL 运维

### 日志

### 监控

### 备份与恢复

### 复制

## MySQL 优化

### 优化思路

- 自顶向下

	- 第一级别

		- 应用系统的 SQL 优化

	- 第二级别

		- MySQL 的服务器优化

	- 第三级别

		- 操作系统\硬件优化

	- 第四级别

		- 系统架构全局优化

			- 负载均衡
			- 缓存
			- 分布式
			- 读写分离
			- 主从

- 软硬结合

	- SQL 语句以及索引优化
	- 表结构\表设计优化
	- 系统配置
	- 服务器硬件配置

