# MySQL(InnoDB)

## 索引（B+树）

索引是一种数据结构，用于加快mysql获取数据的速度；

常见索引模型：哈希表、有序数组、搜索树。

索引类型：主键索引（存储整行数据）、非主键索引（主键的值，需要回表两次查询）

### 数据结构角度

- B+ 树索引（查询性能高、IO 次数少、范围查询简便）

	- 每一个父节点的元素都出现在子节点中，是子节点的最大或最小元素。
	- 非叶子节点不保存数据，只保存关键字用作索引，所有数据都保存在叶子节点中。
	- 内部节点不保存数据，所以能在内存中存放更多索引，增加缓存命中率。

- 哈希索引（单行查询快）

  哈希索引基于哈希表实现，只有精确匹配索引的所有列的查询才有效。对于每一行数据，存储引擎都会对所有的索引列计算一个哈希码，哈希码是一个较小的值，并且不同键值的行计算出来的哈希码也不一样。哈希索引将所有的哈希码存储在索引中，同时在哈希表中保存指向每个数据行的指针。
  
  作者：counterxing
  链接：https://www.zhihu.com/question/67094336/answer/250034118
  来源：知乎
  著作权归作者所有。商业转载请联系作者获得授权，非商业转载请注明出处。

	- 无法用于排序
	- 仅支持 < = > 以及 IN 操作
	- 哈希冲突比较多的话，维护代价高
	- 不能避免全表扫描
	- 不支持部分索引列匹配查找

- FULLTEXT 全文索引（MyISAM 和 InnoDB）

	- 更建议使用 Lucene、Solar 等

- R-Tree索引

	- 解决空间数据检索的问题。

### 物理存储角度

- 聚簇索引（Cluster Index）

	- InnoDB 存储引擎的数据组织方式就是聚簇索引表，完整的记录，存储在主键索引中，通过主键索引，就可以获取记录所有的列。

- 非聚簇索引

	- MyISAM 就是非聚簇索引
	- 叶子节点仍然是索引节点，只不过有指向对应数据块的指针。

### 逻辑角度

- 主键索引，特殊的唯一索引，不允许为空，整行索引
- 普通索引、单列索引
- 多列索引、复合索引（遵循最左前缀原则）
- 唯一索引或者非唯一索引
- 空间索引（只存在 MYISAM 存储引擎中）

### 设计索引的原则

- 搜索的索引列，出现在 where 子句中的列
- 使用唯一索引
- 使用短索引，对字符串列进行索引，去字符串的前 N 个字符
- 利用最左前缀，可以是联合索引的最左N个字段，也可以是字符串索引的最左M个字符。
- 不要过度索引，占磁盘空间，降低写操作性能。
- InnoDB 尽量自己指定主键

### 面试常问的「主键索引、唯一索引和普通索引的区别」

- 主键索引

	- 主键索引只要搜索ID这个B+Tree即可拿到数据。
	- 不允许空值

- 唯一索引

	- 必须唯一，允许空值

- 普通索引

	- 普通索引先搜索索引拿到主键值，再到主键索引树搜索一次(回表)

	  回到主键索引树搜索的过程，称为回表

## 事务

### 事务的特性

- 原子性（Atomic）

  事务中包含的操作被看作一个整体的业务单元，这个业务单元中的操作要么全部成功，要么全部失败，不会出现部分失败、部分成功的场景。

- 一致性（Consistency）

  事务在完成时，必须使所有的数据都保持一致状态，在数据库中所有的修改都基于事务，保证了数据的完整性。

- 隔离性（Isolation）

	- 必须要掌握的知识点

- 持久性（Durability）

  事务结束后，所有的数据会固化到一个地方，如保存到磁盘当中，即使断电重启后也可以提供给应用程序访问。

### 事务的底层日志

- undo log

	- undo log 是回滚日志，提供回滚操作。
	- undo 用来回滚行记录到某个版本。undo log 一般是逻辑日志，根据每行记录进行记录。

- redo log

	- redo log 是重做日志，提供前滚操作
	- redo log 通常是物理日志，记录的是数据页的物理修改，而不是某一行或某几行修改成怎样怎样，它用来恢复提交后的物理数据页(恢复数据页，且只能恢复到最后一次提交的位置)。

## 锁

### 共享锁

### 排它锁

### 乐观锁

### 悲观锁

### GAP 锁

### 2PL（二阶段锁）：

- 加锁阶段
- 解锁阶段
- 保证加锁阶段与解锁阶段不相交。

### 死锁

死锁的发生与否，并不在于事务中有多少条 SQL 语句，死锁的关键在于：两个或以上的 Session 加锁的顺序不一致。

## 隔离级别（当前读）

### 未提交读（Read Uncommited）：脏读

- 可以读取未提交记录。此隔离级别，不会使用，忽略。

### 读写提交（Read Committed，RC）：幻读

- 一个事务只能读取另外一个事务己经提交的数据，
不能读取未提交的数据。
- 幻读的意思其实就是读写提交会产生不可重复读的问题

### 可重复读（Repeatable Read，RR）

- 字面的意思就是必须等上一个事务提交才能进行当前事务的读取操作，保证数据正确性。
- RR 隔离级别保证对读取到的记录加锁 (记录锁)，同时保证对读取的范围加锁，新的满足查询条件的记录不能够插入 (间隙锁)，不存在幻读现象。


- 在这里里面也有一个「幻读」的概念，不过可重复读产生幻读的现象不属于数据库存储的值，多半是统计值或者计算值。

### 串行化（Serializable）

- 从 MVCC 并发控制退化为基于锁的并发控制。不区别快照读与当前读，所有的读操作均为当前读，读加读锁 (S锁，共享锁)，写加写锁 (X锁，排它锁)。
- Serializable 隔离级别下，读写冲突，因此并发度急剧下降，在 MySQL/InnoDB 下不建议使用。

## MVCC（Multi-Version Concurrency Control，基于多版本的并发控制协议）：读不加锁，读写不冲突。

### 快照读（snapshot read）

- 简单的select操作，属于快照读，不加锁。

### 当前读（current read）

- 特殊的读操作，插入/更新/删除操作，属于当前读，需要加锁。

	- select * from table where ? lock in share mode;（共享锁）
	- select * from table where ? for update;（排它锁）
	- insert into table values (…);
	- update table set ? where ?;
	- delete from table where ?;

## 一条 SQL 的生命周期

### 词法解析、语法解析、权限检查、查询优化、SQL执行等

### where 的提取

- Index Key，索引的起始范围

	- Index First Key
	- Index Last Key

- Index Filter，索引起始范围之外依然满足查询条件的查询范围，逐个索引列检索
- Table Filter，不属于索引列的查询条件

### 执行计划

- 主键扫描
- 唯一键扫描
- 范围扫描
- 全表扫描

## 表

### 分类

- 堆表：无序存储
- 聚簇索引表：按照主键顺序存储

